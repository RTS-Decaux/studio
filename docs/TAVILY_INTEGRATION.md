# Интеграция Tavily Search

## Обзор

Tavily Search интегрирован в проект как AI tool, позволяющий модели выполнять веб-поиск в режиме реального времени для получения актуальной информации из интернета.

## Установка и настройка

### 1. Установка пакета

Пакет уже установлен в проекте:

```json
"@tavily/core": "^0.5.12"
```

### 2. Получение API ключа

1. Зарегистрируйтесь на [Tavily](https://tavily.com)
2. Получите API ключ в личном кабинете
3. Добавьте ключ в файл `.env.local`:

```bash
TAVILY_API_KEY=tvly-ваш-ключ-здесь
```

### 3. Проверка конфигурации

Убедитесь, что переменная окружения установлена:

```bash
echo $TAVILY_API_KEY
```

## Использование

### Основное использование

После настройки инструмент `webSearch` автоматически доступен в чате. Модель может использовать его для:

- Поиска актуальной информации и новостей
- Проверки фактов
- Получения данных о текущих событиях
- Поиска технической документации

### Примеры запросов

Пользователь может задать вопросы, которые требуют актуальной информации:

- "Что происходит в мире технологий сегодня?"
- "Какая сейчас погода в Москве?" (с использованием веб-поиска)
- "Последние новости о Next.js 15"
- "Найди информацию о новых возможностях TypeScript"

### Параметры поиска

Инструмент `webSearch` поддерживает следующие параметры:

| Параметр | Тип | По умолчанию | Описание |
|----------|-----|--------------|----------|
| `query` | string | (обязательно) | Поисковый запрос (1-200 символов) |
| `maxResults` | number | 5 | Максимальное количество результатов (1-10) |
| `searchDepth` | 'basic' \| 'advanced' | 'basic' | Глубина поиска |
| `includeAnswer` | boolean | true | Включать ли сгенерированный ответ |

### Формат ответа

```typescript
{
  query: string;              // Исходный запрос
  answer?: string;            // Сгенерированный ответ на основе результатов
  results: Array<{
    title: string;            // Заголовок результата
    url: string;              // URL источника
    content: string;          // Краткое содержание
    score: number;            // Релевантность (0-1)
    publishedDate?: string;   // Дата публикации (если доступна)
  }>;
  images?: string[];          // URLs изображений
  responseTime?: number;      // Время ответа в мс
}
```

## Архитектура

### Файловая структура

```
lib/ai/tools/
├── web-search.ts           # Tavily Search tool
├── get-weather.ts          # Weather tool
├── create-document.ts      # Document creation tool
├── update-document.ts      # Document update tool
└── request-suggestions.ts  # Suggestions tool
```

### Интеграция в API

Инструмент интегрирован в `/app/(chat)/api/chat/route.ts`:

```typescript
import { webSearch } from "@/lib/ai/tools/web-search";

// ...

tools: {
  webSearch,
  getWeather,
  createDocument: createDocument({ user, dataStream }),
  updateDocument: updateDocument({ user, dataStream }),
  requestSuggestions: requestSuggestions({ user, dataStream }),
}
```

### Типизация

Типы инструмента определены в `/lib/types.ts`:

```typescript
import type { webSearch } from "./ai/tools/web-search";

type webSearchTool = InferUITool<typeof webSearch>;

export type ChatTools = {
  getWeather: weatherTool;
  webSearch: webSearchTool;
  // ...
};
```

## Ограничения и рекомендации

### Лимиты API

- Бесплатный план: обычно 1000 запросов в месяц
- Платные планы: от 5000 до неограниченного количества запросов
- Проверьте текущие лимиты на [tavily.com/pricing](https://tavily.com/pricing)

### Рекомендации по использованию

1. **Кэширование**: Для часто запрашиваемой информации рассмотрите возможность кэширования результатов
2. **Обработка ошибок**: Инструмент корректно обрабатывает ошибки и возвращает понятные сообщения
3. **Глубина поиска**: Используйте `searchDepth: "advanced"` только когда нужна более глубокая информация
4. **Количество результатов**: Начните с `maxResults: 3-5` для оптимального баланса между качеством и скоростью

### Отключение инструмента

Если необходимо временно отключить веб-поиск:

1. Удалите или закомментируйте `TAVILY_API_KEY` в `.env.local`
2. Инструмент вернет сообщение об ошибке конфигурации

Или удалите `webSearch` из списка `tools` в `route.ts`.

## Безопасность

- ✅ API ключ хранится в переменных окружения (не в коде)
- ✅ Ключ никогда не отправляется на клиент
- ✅ Результаты поиска санитизируются перед отправкой модели
- ✅ Лимиты на длину запроса (max 200 символов)
- ✅ Лимиты на количество результатов (max 10)

## Мониторинг и отладка

### Логирование

Ошибки поиска логируются в консоль:

```typescript
console.error("Tavily search error:", error);
```

### Проверка работоспособности

Задайте модели вопрос, требующий актуальной информации, и проверьте:

1. Используется ли инструмент `webSearch` (видно в логах)
2. Возвращаются ли релевантные результаты
3. Корректность форматирования ответа

## Расширенные возможности

### Дополнительные параметры Tavily API

При необходимости можно расширить инструмент дополнительными параметрами:

```typescript
const response = await tavilyClient.search(query, {
  maxResults,
  searchDepth,
  includeAnswer,
  includeRawContent: true,    // Полное содержимое страниц
  includeDomains: ["example.com"], // Поиск только на определенных доменах
  excludeDomains: ["spam.com"],    // Исключить домены
  topic: "general",           // Категория: general, news, finance
});
```

### Интеграция с другими инструментами

Tavily Search можно комбинировать с другими инструментами:

```typescript
// Пример: Поиск + создание документа
1. Модель использует webSearch для получения информации
2. Модель использует createDocument для создания отчета
3. Результат: структурированный документ с актуальными данными
```

## Поддержка

При возникновении проблем:

1. Проверьте наличие и корректность `TAVILY_API_KEY`
2. Убедитесь, что не превышены лимиты API
3. Проверьте логи сервера на наличие ошибок
4. Обратитесь к [документации Tavily](https://docs.tavily.com)

## Changelog

### v1.0.0 (Ноябрь 2025)
- ✅ Первичная интеграция Tavily Search
- ✅ Базовый функционал поиска
- ✅ Обработка ошибок
- ✅ Типизация TypeScript
- ✅ Документация
